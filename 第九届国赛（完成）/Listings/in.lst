C51 COMPILER V9.54   IN                                                                    04/05/2023 16:17:14 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE IN
OBJECT MODULE PLACED IN .\Objects\in.obj
COMPILER INVOKED BY: F:\kile 5\C51\BIN\C51.EXE in.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\lib) DEBUG OBJECTEXTEND PRINT(.\Li
                    -stings\in.lst) TABS(2) OBJECT(.\Objects\in.obj)

line level    source

   1          #include <STC15F2K60S2.H>
   2          #define __REG52_H__
   3          #include "iic.h"
   4          #include "onewire.h"
   5          
   6          #define YY P2=(P2&0x1f)
   7          #define Y4 YY|0x80
   8          #define Y5 YY|0xa0
   9          #define Y6 YY|0xc0
  10          #define Y7 YY|0xe0
  11          
  12          typedef unsigned char u8;
  13          typedef unsigned int u16;
  14          
  15          #define SYS P0=0xff;Y4;YY;P0=0x00;Y5;YY;
  16          
  17          u8  Time10ms,ADC_Time10ms,WD_Time10ms,LED_V=0xff;
  18          u16 Time1S,NE555;
  19          
  20          //                                                                     10   11p 12n  13u  14-  15f  16c
  21          u8 code LED_duan[]={0xC0,0xF9,0xA4,0xB0,0x99,0x92,0x82,0xF8,0x80,0x90,0xff,0x8c,0xc8,0xc1,0xbf,0x8e,0xc6,
  22          0xC0&0x7f,0xF9&0x7f,0xA4&0x7f,0xB0&0x7f,0x99&0x7f,0x92&0x7f,0x82&0x7f,0xF8&0x7f,0x80&0x7f,0x90&0x7f,0x89};
  23          u8 LED_buff[]={10,10,10,10,10,10,10,10};
  24          
  25          void LED(){P0=LED_V;Y4;YY;}
  26          void Timer0_Init(void)
  27          {
  28   1        AUXR |= 0x80;
  29   1        TMOD &= 0xF0;
  30   1        TMOD |= 0x05;
  31   1        TL0 = 0x00;   
  32   1        TH0 = 0x00;   
  33   1        TF0 = 0;      
  34   1        TR0 = 1;      
  35   1      }
  36          
  37          void Timer1_Init(void)    //1??@12.000MHz
  38          {
  39   1        AUXR |= 0x40;     //?????1T??
  40   1        TMOD &= 0x0F;     //???????
  41   1        TL1 = 0x20;       //???????
  42   1        TH1 = 0xD1;       //???????
  43   1        TF1 = 0;        //??TF1??
  44   1        TR1 = 1;        //???1????
  45   1        EA=1;
  46   1        ET1=1;
  47   1      }
  48          
  49          void Delay5ms()   //@12.000MHz
  50          {
  51   1        unsigned char i, j;
  52   1      
  53   1        i = 59;
  54   1        j = 90;
C51 COMPILER V9.54   IN                                                                    04/05/2023 16:17:14 PAGE 2   

  55   1        do
  56   1        {
  57   2          while (--j);
  58   2        } while (--i);
  59   1      }
  60          
  61          
  62          void LED_display()
  63          {
  64   1        static u8 i;
  65   1        P0=0xff;Y7;YY;
  66   1        P0=0x01<<i;Y6;YY;
  67   1        P0=LED_duan[LED_buff[i]];Y7;YY;
  68   1        if(++i==8)i=0;
  69   1      }
  70          
  71          void LED_displaybuff(u8 d1,d2,d3,d4,d5,d6,d7,d8)
  72          {
  73   1        LED_buff[0]=d1;
  74   1        LED_buff[1]=d2;
  75   1        LED_buff[2]=d3;
  76   1        LED_buff[3]=d4;
  77   1        LED_buff[4]=d5;
  78   1        LED_buff[5]=d6;
  79   1        LED_buff[6]=d7;
  80   1        LED_buff[7]=d8;
  81   1      }
  82          
  83          u16 ADCR,ADC;
  84          void ADC_R(u8 channl)
  85          {
  86   1        IIC_Start();
  87   1        IIC_SendByte(0x90); 
  88   1        IIC_WaitAck();
  89   1        IIC_SendByte(channl);
  90   1        IIC_WaitAck(); 
  91   1        
  92   1        IIC_Start();
  93   1        IIC_SendByte(0x91); 
  94   1        IIC_WaitAck();
  95   1        ADCR=IIC_RecByte();
  96   1        IIC_SendAck(1); 
  97   1        IIC_Stop();
  98   1        
  99   1        ADC=ADCR*50.0/255;
 100   1      }
 101          
 102          void DAC_W(u8 dat)
 103          {
 104   1        IIC_Start();
 105   1        IIC_SendByte(0x90); 
 106   1        IIC_WaitAck();  
 107   1        IIC_SendByte(0x40); 
 108   1        IIC_WaitAck(); 
 109   1        IIC_SendByte(dat);
 110   1        IIC_WaitAck(); 
 111   1        IIC_Stop();
 112   1      }
 113          
 114          u16 WD;
 115          void DS18B20_R()
 116          {
C51 COMPILER V9.54   IN                                                                    04/05/2023 16:17:14 PAGE 3   

 117   1        u8 L,H;
 118   1        u16 Temp;
 119   1        init_ds18b20();
 120   1        Write_DS18B20(0xcc);
 121   1        Write_DS18B20(0x44);
 122   1        
 123   1        Delay_OneWire(200);
 124   1        
 125   1        init_ds18b20();
 126   1        Write_DS18B20(0xcc);
 127   1        Write_DS18B20(0xbe);
 128   1        
 129   1        L=Read_DS18B20();
 130   1        H=Read_DS18B20();
 131   1        
 132   1        Temp=(H&0x0f)<<8;
 133   1        Temp|=L;
 134   1        
 135   1        WD=Temp*6.25;
 136   1      }
 137          
 138          void EEPROM_W(u8 addr,dat)
 139          {
 140   1        IIC_Start();
 141   1        IIC_SendByte(0xa0);
 142   1        IIC_WaitAck(); 
 143   1        IIC_SendByte(addr);
 144   1        IIC_WaitAck();
 145   1        IIC_SendByte(dat); 
 146   1        IIC_WaitAck();
 147   1        IIC_Stop();
 148   1      }
 149          u16 EEPR;
 150          void EEPROM_R(u8 addr)
 151          {
 152   1        IIC_Start();
 153   1        IIC_SendByte(0xa0);
 154   1        IIC_WaitAck(); 
 155   1        IIC_SendByte(addr);
 156   1        IIC_WaitAck();
 157   1        
 158   1        IIC_Start();
 159   1        IIC_SendByte(0xa1);
 160   1        IIC_WaitAck();
 161   1        EEPR=IIC_RecByte();
 162   1        IIC_Stop();
 163   1      }
 164          
 165          u8 key_steta,key_value;
 166          void key_scan()
 167          {
 168   1        P3=0x0f;
 169   1        if(~P3&0x0f)
 170   1        {
 171   2          if(key_steta<255)key_steta++;
 172   2          if(P30==0)key_value=7;
 173   2          if(P31==0)key_value=6;
 174   2          if(P32==0)key_value=5;
 175   2          if(P33==0)key_value=4;
 176   2          
 177   2        }else
 178   1        {
C51 COMPILER V9.54   IN                                                                    04/05/2023 16:17:14 PAGE 4   

 179   2          key_steta=0;
 180   2          key_value=0;
 181   2        }
 182   1      }
 183          u8 key_flag,key_H_flag,ADC_value,HX_flag,key_HX_flag;
 184          u16 EEPR_WD,EEPR_ADC,EEPR_NE555;
 185          void key_dispose()
 186          {
 187   1        key_scan();
 188   1        if(key_value==7&&key_steta==2)
 189   1        {
 190   2          key_flag=3;
 191   2          key_HX_flag=!key_HX_flag;
 192   2        }
 193   1        if(key_value==6&&key_steta==2&&HX_flag==0)
 194   1        {
 195   2          if(ADC_value>=50||ADC_value<=0){ADC_value=1;}else{++ADC_value;}
 196   2        }
 197   1        if(key_value==6&&key_steta==2&&HX_flag==1)
 198   1        {
 199   2          key_H_flag=!key_H_flag;
 200   2          EEPROM_R(0x00);
 201   2          EEPR_ADC=EEPR;
 202   2          EEPROM_R(0x01);
 203   2          EEPR_WD=EEPR*100;
 204   2          EEPROM_R(0x02);
 205   2          EEPR_WD=EEPR_WD+EEPR;
 206   2          EEPROM_R(0x03);
 207   2          EEPR_NE555=EEPR*1000;
 208   2          EEPROM_R(0x04);
 209   2          EEPR_NE555=EEPR_NE555+EEPR*10;
 210   2          EEPROM_R(0x05);
 211   2          EEPR_NE555=EEPR_NE555+EEPR;
 212   2        }
 213   1        
 214   1        
 215   1        if(key_value==5&&key_steta==2)
 216   1        {
 217   2          EEPROM_W(0x00,ADC);Delay5ms();
 218   2          EEPROM_W(0x01,WD/100);Delay5ms();
 219   2          EEPROM_W(0x02,WD%100);Delay5ms();
 220   2          EEPROM_W(0x03,NE555/1000);Delay5ms();
 221   2          EEPROM_W(0x04,NE555%1000/10);Delay5ms();
 222   2          EEPROM_W(0x05,NE555%10);Delay5ms();
 223   2        }
 224   1        if(key_value==4&&key_steta==2)
 225   1        {
 226   2          if(++key_flag==3){key_flag=0;}
 227   2        }
 228   1      
 229   1      }
 230          
 231          void JM_QH()
 232          {
 233   1        switch(key_flag)
 234   1        {
 235   2          case 0:
 236   2            HX_flag=1;
 237   2            if(key_H_flag==0)
 238   2            {
 239   3              LED_V&=0xfb;
 240   3              LED_V|=~0xfd;
C51 COMPILER V9.54   IN                                                                    04/05/2023 16:17:14 PAGE 5   

 241   3              LED_V|=~0xfe;
 242   3              LED_displaybuff(13,10,10,10,10,10,ADC/10+17,ADC%10);
 243   3            }
 244   2            else
 245   2            {
 246   3              
 247   3              LED_displaybuff(27,13,10,10,10,10,EEPR_ADC/10+17,EEPR_ADC%10);
 248   3            }
 249   2          break;
 250   2          case 1:
 251   2            HX_flag=1;
 252   2            if(key_H_flag==0)
 253   2            {
 254   3              LED_V&=0xfd;
 255   3              LED_V|=~0xfe;
 256   3              LED_V|=~0xfb;
 257   3              LED_displaybuff(15,10,10,NE555/10000,NE555%10000/1000,NE555%10000%1000/100,NE555%10000%1000%100/10,NE5
             -55%10);
 258   3            }
 259   2            else
 260   2            { 
 261   3              
 262   3              LED_displaybuff(27,15,10,EEPR_NE555/10000,EEPR_NE555%10000/1000,EEPR_NE555%10000%1000/100,EEPR_NE555%1
             -0000%1000%100/10,EEPR_NE555%10);
 263   3            }
 264   2          break;
 265   2          case 2:
 266   2            HX_flag=1;
 267   2            if(key_H_flag==0)
 268   2            {
 269   3              LED_V&=0xfe;
 270   3              LED_V|=~0xfd;
 271   3              LED_V|=~0xfb;
 272   3              LED_displaybuff(16,10,10,10,WD/1000,WD%1000/100+17,WD%1000%100/10,WD%10);
 273   3            }
 274   2            else
 275   2            {
 276   3              LED_displaybuff(27,16,10,10,EEPR_WD/1000,EEPR_WD%1000/100+17,EEPR_WD%1000%100/10,EEPR_WD%10);
 277   3            }
 278   2          break;
 279   2          case 3:
 280   2              HX_flag=0;
 281   2              LED_displaybuff(11,10,10,10,10,10,ADC_value/10+17,ADC_value%10);
 282   2              if(key_HX_flag==0){key_flag=0;}
 283   2          break;
 284   2        }
 285   1      }
 286          
 287          void main()
 288          {
 289   1        SYS;
 290   1        Timer0_Init();
 291   1        Timer1_Init();
 292   1        
 293   1        while(1)
 294   1        {
 295   2          if(Time1S%20==0){ADC_R(0x03);ADC_Time10ms=0;}
 296   2          if(Time1S%800==0){DS18B20_R();WD_Time10ms=0;}
 297   2          JM_QH();
 298   2        }
 299   1        
 300   1      
C51 COMPILER V9.54   IN                                                                    04/05/2023 16:17:14 PAGE 6   

 301   1      }
 302          
 303          void Time1_interrupt() interrupt 3
 304          {
 305   1        ++Time1S;
 306   1        if(++Time10ms==10){Time10ms=0;key_dispose();}
 307   1        if(Time1S%5){LED();}
 308   1        if(Time1S==1000)
 309   1        {
 310   2          Time1S=0;
 311   2          TR0=0;
 312   2          NE555=TH0<<8;
 313   2          NE555|=TL0;
 314   2          TL0 = 0x00;   
 315   2          TH0 = 0x00;
 316   2          TR0=1;
 317   2        }
 318   1        
 319   1        
 320   1        LED_display();
 321   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1980    ----
   CONSTANT SIZE    =     28    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     38      22
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
